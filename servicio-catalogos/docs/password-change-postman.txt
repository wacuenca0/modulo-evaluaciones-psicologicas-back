PRUEBAS POSTMAN - FLUJO DE SOLICITUD Y CAMBIO DE CONTRASENA
================================================================

1. PREPARACION DEL ENTORNO
---------------------------
- Crear una variable de entorno en Postman llamada `baseUrl` con la URL base del servicio (por ejemplo `http://localhost:8082`).
- Crear variables `adminUser` y `adminPass` con `admin` y `Admin#123` respectivamente (pueden ajustarse si se cambio la configuracion).
- Declarar una variable de entorno `adminToken` (inicialmente vacia) para almacenar el JWT del administrador.
- Todas las solicitudes protegidas deben incluir el header `Authorization: Bearer {{adminToken}}`.

2. COLECCION RECOMENDADA
------------------------
Se sugiere crear la coleccion `Password Change Flow` en Postman con las siguientes solicitudes en orden. Cada solicitud incluye un bloque de pruebas (Tests) para validar la respuesta y encadenar datos.

2.1 LOGIN ADMINISTRADOR
- Metodo: POST
- URL: {{baseUrl}}/api/auth/login
- Body (JSON):
  {
    "username": "{{adminUser}}",
    "password": "{{adminPass}}"
  }
- Tests:
```javascript
pm.test("codigo 200", function () {
    pm.response.to.have.status(200);
});
pm.environment.set("adminToken", pm.response.text());
pm.test("token no vacio", function () {
    pm.expect(pm.environment.get("adminToken")).to.be.ok;
});
```

2.2 CREAR SOLICITUD DE CAMBIO
- Metodo: POST
- URL: {{baseUrl}}/api/password-requests
- Headers: Content-Type application/json (no requiere token)
- Body (JSON ejemplo):
  {
    "username": "usuario.demo",
    "contactEmail": "usuario.demo@dominio.mil",
    "motivo": "Usuario bloqueado luego de intentos fallidos"
  }
- Tests:
```javascript
pm.test("codigo 201", function () {
    pm.response.to.have.status(201);
});
const body = pm.response.json();
pm.environment.set("passwordRequestId", body.id);
pm.test("estado pendiente", function () {
    pm.expect(body.status).to.eql("PENDIENTE");
});
```
- Resultado esperado: respuesta 201 con objeto `PasswordChangeRequestDTO` y estado `PENDIENTE`. Solo se permite una solicitud pendiente por usuario.

2.3 LISTAR SOLICITUDES PENDIENTES
- Metodo: GET
- URL: {{baseUrl}}/api/password-requests?status=PENDIENTE
- Headers: Authorization Bearer {{adminToken}}
- Tests:
```javascript
pm.test("codigo 200", function () {
    pm.response.to.have.status(200);
});
const lista = pm.response.json();
pm.test("lista contiene la solicitud", function () {
    const id = Number(pm.environment.get("passwordRequestId"));
    const encontrada = lista.some(item => item.id === id);
    pm.expect(encontrada).to.be.true;
});
```

2.4 COMPLETAR SOLICITUD (CAMBIAR CONTRASENA)
- Metodo: POST
- URL: {{baseUrl}}/api/password-requests/{{passwordRequestId}}/complete
- Headers: Authorization Bearer {{adminToken}}
- Body (JSON ejemplo):
  {
    "newPassword": "NuevaClave#456",
    "adminNotes": "Se reinicio la clave y se desbloqueo la cuenta",
    "unlockAccount": true
  }
- Tests:
```javascript
pm.test("codigo 200", function () {
    pm.response.to.have.status(200);
});
const body = pm.response.json();
pm.test("estado completado", function () {
    pm.expect(body.status).to.eql("COMPLETADO");
});
pm.test("procesado por admin", function () {
    pm.expect(body.processedBy).to.eql(pm.environment.get("adminUser"));
});
```
- Efecto esperado: la contrase単a del usuario se actualiza, la cuenta deja de estar bloqueada cuando `unlockAccount` es `true` y la solicitud pasa a estado `COMPLETADO`.

2.5 RECHAZAR SOLICITUD (CAMINO ALTERNATIVO)
- Metodo: POST
- URL: {{baseUrl}}/api/password-requests/{{passwordRequestId}}/reject
- Headers: Authorization Bearer {{adminToken}}
- Body (JSON opcional):
  {
    "adminNotes": "No se pudo validar la identidad del usuario"
  }
- Tests:
```javascript
pm.test("codigo 200", function () {
    pm.response.to.have.status(200);
});
pm.test("estado rechazado", function () {
    pm.expect(pm.response.json().status).to.eql("RECHAZADO");
});
```
- Utilizar esta solicitud solo cuando se desee validar el camino alternativo. Para reutilizar la coleccion, crear primero una nueva solicitud pendiente (paso 2.2) antes de rechazarla.

3. FLUJO FUNCIONAL DETALLADO
----------------------------
1) Un usuario final envia una solicitud POST `/api/password-requests` indicando su username y datos de contacto. El servicio verifica que el usuario existe y que no tenga solicitudes pendientes; crea un registro con estado `PENDIENTE`, guardando la fecha `requestedAt` y, si no se indica correo, reutiliza el del usuario.
2) El administrador inicia sesion (`/api/auth/login`) y usa su token JWT para consultar solicitudes. Puede listar todas con `GET /api/password-requests` o filtrar por estado (`PENDIENTE`, `COMPLETADO`, `RECHAZADO`).
3) Para completar el proceso, el administrador llama `POST /api/password-requests/{id}/complete` con la nueva contrase単a y, opcionalmente, notas y `unlockAccount`. El servicio aplica la contrase単a cifrada al usuario (`PasswordEncoder`), limpia el bloqueo si corresponde y marca la solicitud como `COMPLETADO`, registrando `processedAt`, `processedBy` y `adminNotes`.
4) Si la solicitud no procede, el administrador usa `POST /api/password-requests/{id}/reject`. El servicio conserva la solicitud con estado `RECHAZADO`, agrega notas (si las hay) y fecha/hora de procesamiento.
5) Estados terminales: `COMPLETADO` o `RECHAZADO`. Cualquier intento posterior de procesar una solicitud ya atendida genera error 400 (estado HTTP depende del manejador global). Para nueva atencion, el usuario debe generar otra solicitud.

4. VALIDACIONES Y ERRORES COMUNES
---------------------------------
- Usuario inexistente: 400 con mensaje "Usuario no encontrado".
- Solicitud duplicada en estado pendiente: 409/400 con mensaje "Ya existe una solicitud pendiente para este usuario".
- Completar sin `newPassword`: 400 "Debe indicar la nueva contrase単a".
- Operaciones sobre solicitudes ya atendidas: 409/400 "La solicitud ya fue atendida".

5. VERIFICACION ADICIONAL (OPCIONAL)
------------------------------------
- Ejecutar login del usuario con la nueva clave para confirmar el cambio.
- Consultar la base de datos (tabla `PASSWORD_CHANGE_REQUEST`) para revisar campos `REQUESTED_AT`, `PROCESSED_AT`, `PROCESSED_BY` y `STATUS`.

6. RESTABLECER DATOS ENTRE ESCENARIOS
-------------------------------------
- Para repetir el flujo completo, generar una nueva solicitud (paso 2.2) antes de completar o rechazar.
- En caso de pruebas automatizadas, se recomienda limpiar registros pendientes mediante script SQL o endpoint de mantenimiento (no incluido en este servicio).
